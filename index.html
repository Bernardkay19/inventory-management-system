<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Inventory Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        font-family: "Inter", sans-serif;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 50;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.5);
        transition: opacity 0.3s ease;
      }
      .modal-content {
        background-color: #fefefe;
        margin: 10% auto;
        padding: 24px;
        border-radius: 8px;
        width: 90%;
        max-width: 500px;
        position: relative;
        transform: translateY(-50px);
        transition: transform 0.3s ease;
      }
      .modal.show {
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .modal.show .modal-content {
        transform: translateY(0);
      }
      .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
      }
      .close-button:hover,
      .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
      }
      .tab-button.active {
        border-bottom: 2px solid #3b82f6;
        color: #3b82f6;
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">
      <header
        class="flex flex-col md:flex-row justify-between items-center mb-6"
      >
        <h1 class="text-3xl font-bold text-gray-900 mb-4 md:mb-0">
          Inventory Dashboard
        </h1>
        <button
          id="addItemBtn"
          class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300 w-full md:w-auto"
        >
          Add New Item
        </button>
      </header>

      <!-- Main Content -->
      <main>
        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
          <nav class="flex space-x-4" aria-label="Tabs">
            <button
              id="inventoryTab"
              class="tab-button active py-4 px-1 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent"
            >
              Inventory
            </button>
            <button
              id="salesTab"
              class="tab-button py-4 px-1 text-sm font-medium text-gray-500 hover:text-blue-600 border-b-2 border-transparent"
            >
              Sales Report
            </button>
          </nav>
        </div>

        <!-- Inventory View -->
        <div id="inventoryView">
          <!-- Summary Cards -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow">
              <h3 class="text-gray-500 font-semibold">Total Items</h3>
              <p id="totalItems" class="text-3xl font-bold">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
              <h3 class="text-gray-500 font-semibold">Items Out of Stock</h3>
              <p id="outOfStock" class="text-3xl font-bold text-red-500">0</p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
              <h3 class="text-gray-500 font-semibold">Total Categories</h3>
              <p id="totalCategories" class="text-3xl font-bold">0</p>
            </div>
          </div>

          <!-- Inventory List -->
          <div
            id="inventoryList"
            class="bg-white rounded-lg shadow overflow-hidden"
          >
            <!-- This will be populated by JavaScript -->
          </div>
        </div>

        <!-- Sales Report View -->
        <div id="salesView" class="hidden">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <div class="bg-white p-6 rounded-lg shadow">
              <h3 class="text-gray-500 font-semibold">Today's Total Sales</h3>
              <p id="totalSalesValue" class="text-3xl font-bold text-green-600">
                $0.00
              </p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
              <h3 class="text-gray-500 font-semibold">Total Transactions</h3>
              <p id="totalTransactions" class="text-3xl font-bold">0</p>
            </div>
          </div>
          <div class="bg-white rounded-lg shadow overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <thead class="bg-gray-50">
                <tr>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Item Name
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Quantity
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Price
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Total
                  </th>
                  <th
                    scope="col"
                    class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                  >
                    Time
                  </th>
                </tr>
              </thead>
              <tbody
                id="salesReportList"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- Populated by JavaScript -->
              </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>

    <!-- Add/Edit Item Modal -->
    <div id="itemModal" class="modal">
      <div class="modal-content">
        <span id="closeModal" class="close-button">&times;</span>
        <h2 id="modalTitle" class="text-2xl font-bold mb-4">Add New Item</h2>
        <form id="itemForm">
          <input type="hidden" id="itemId" />
          <div class="mb-4">
            <label
              for="itemName"
              class="block text-sm font-medium text-gray-700"
              >Item Name</label
            >
            <input
              type="text"
              id="itemName"
              name="itemName"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              required
            />
          </div>
          <div class="mb-4">
            <label
              for="itemCategory"
              class="block text-sm font-medium text-gray-700"
              >Category</label
            >
            <input
              type="text"
              id="itemCategory"
              name="itemCategory"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              required
            />
          </div>
          <div class="grid grid-cols-2 gap-4 mb-6">
            <div>
              <label
                for="itemQuantity"
                class="block text-sm font-medium text-gray-700"
                >Quantity</label
              >
              <input
                type="number"
                id="itemQuantity"
                name="itemQuantity"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                required
                min="0"
              />
            </div>
            <div>
              <label
                for="itemPrice"
                class="block text-sm font-medium text-gray-700"
                >Price ($)</label
              >
              <input
                type="number"
                id="itemPrice"
                name="itemPrice"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
                required
                min="0"
                step="0.01"
              />
            </div>
          </div>
          <div class="flex justify-end">
            <button
              type="submit"
              id="saveItemBtn"
              class="bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300"
            >
              Save Item
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Sell Item Modal -->
    <div id="sellModal" class="modal">
      <div class="modal-content">
        <span id="closeSellModal" class="close-button">&times;</span>
        <h2 class="text-2xl font-bold mb-4">Sell Item</h2>
        <p class="mb-4">Selling: <strong id="sellItemName"></strong></p>
        <p class="mb-4">In Stock: <strong id="sellItemStock"></strong></p>
        <form id="sellForm">
          <input type="hidden" id="sellItemId" />
          <div class="mb-4">
            <label
              for="sellQuantity"
              class="block text-sm font-medium text-gray-700"
              >Quantity to Sell</label
            >
            <input
              type="number"
              id="sellQuantity"
              name="sellQuantity"
              class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500"
              required
              min="1"
            />
          </div>
          <div class="flex justify-end">
            <button
              type="submit"
              class="bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300"
            >
              Confirm Sale
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      // Firebase imports (using Firebase v11.6.1 CDN)
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
      import {
        getAuth,
        signInAnonymously,
        signInWithCustomToken,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
      import {
        getFirestore,
        collection,
        onSnapshot,
        doc,
        addDoc,
        setDoc,
        getDoc,
        deleteDoc,
        serverTimestamp,
        query,
        where,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

      // Your Firebase configuration object
      const firebaseConfig = {
        apiKey: "AIzaSyDaGQEiUC8cwp0hOVRRI658fOi2ArhiT1g",
        authDomain: "inventory-management-app-78fd2.firebaseapp.com",
        projectId: "inventory-management-app-78fd2",
        storageBucket: "inventory-management-app-78fd2.appspot.com", // Fixed URL
        messagingSenderId: "253664290568",
        appId: "1:253664290568:web:0c0731f3ce71ea9c1ceebd",
        measurementId: "G-Q587BY9WGM",
      };

      // --- Firebase Globals ---
      const appId = "default-inventory-app"; // or set dynamically if needed
      let db, auth;
      let userId;
      let inventoryCollection;
      let salesCollection;
      let unsubscribeInventory = () => {};
      let unsubscribeSales = () => {};

      // --- Authentication & Setup ---
      async function setupAppForUser() {
        try {
          // Initialize Firebase app
          const app = initializeApp(firebaseConfig);
          db = getFirestore(app);
          auth = getAuth(app);

          // Sign in user (custom token or anonymous)
          if (
            typeof __initial_auth_token !== "undefined" &&
            __initial_auth_token
          ) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }

          userId = auth.currentUser.uid;
          if (!userId) {
            console.error("Authentication failed, user ID is null.");
            return;
          }

          // Define Firestore collections based on user ID
          const basePath = `/artifacts/${appId}/users/${userId}`;
          inventoryCollection = collection(db, `${basePath}/inventory`);
          salesCollection = collection(db, `${basePath}/sales`);

          // Start listening for real-time updates
          listenForInventoryUpdates();
          listenForSalesUpdates();
        } catch (error) {
          console.error("Authentication or app setup error:", error);
          document.getElementById(
            "app"
          ).innerHTML = `<div class="text-center p-8 bg-red-100 text-red-700 rounded-lg">Error: ${error.message}</div>`;
        }
      }

      // --- UI Elements ---
      const addItemBtn = document.getElementById("addItemBtn");
      const itemModal = document.getElementById("itemModal");
      const closeModal = document.getElementById("closeModal");
      const itemForm = document.getElementById("itemForm");
      const sellModal = document.getElementById("sellModal");
      const closeSellModal = document.getElementById("closeSellModal");
      const sellForm = document.getElementById("sellForm");

      const inventoryTab = document.getElementById("inventoryTab");
      const salesTab = document.getElementById("salesTab");
      const inventoryView = document.getElementById("inventoryView");
      const salesView = document.getElementById("salesView");

      // --- Modal Logic ---
      function openModal() {
        itemForm.reset();
        document.getElementById("itemId").value = "";
        document.getElementById("modalTitle").textContent = "Add New Item";
        itemModal.classList.add("show");
      }

      function closeModalHandler() {
        itemModal.classList.remove("show");
      }

      function openSellModal(item) {
        document.getElementById("sellItemId").value = item.id;
        document.getElementById("sellItemName").textContent = item.name;
        document.getElementById("sellItemStock").textContent = item.quantity;
        document.getElementById("sellQuantity").max = item.quantity;
        document.getElementById("sellQuantity").value = 1;
        sellModal.classList.add("show");
      }

      function closeSellModalHandler() {
        sellModal.classList.remove("show");
      }

      addItemBtn.onclick = openModal;
      closeModal.onclick = closeModalHandler;
      closeSellModal.onclick = closeSellModalHandler;

      window.onclick = function (event) {
        if (event.target == itemModal) {
          closeModalHandler();
        }
        if (event.target == sellModal) {
          closeSellModalHandler();
        }
      };

      // --- Tab Switching Logic ---
      inventoryTab.addEventListener("click", () => {
        inventoryView.classList.remove("hidden");
        salesView.classList.add("hidden");
        inventoryTab.classList.add("active");
        salesTab.classList.remove("active");
      });

      salesTab.addEventListener("click", () => {
        inventoryView.classList.add("hidden");
        salesView.classList.remove("hidden");
        inventoryTab.classList.remove("active");
        salesTab.classList.add("active");
      });

      // --- Firestore Data Logic ---

      // Listen for inventory updates
      function listenForInventoryUpdates() {
        unsubscribeInventory(); // Unsubscribe from any previous listener
        unsubscribeInventory = onSnapshot(
          inventoryCollection,
          (snapshot) => {
            const inventory = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            renderInventory(inventory);
            updateSummary(inventory);
          },
          (error) => {
            console.error("Error listening to inventory collection:", error);
          }
        );
      }

      // Listen for today's sales updates
      function listenForSalesUpdates() {
        unsubscribeSales(); // Unsubscribe from any previous listener
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const startOfToday = Timestamp.fromDate(today);

        const salesQuery = query(
          salesCollection,
          where("timestamp", ">=", startOfToday)
        );

        unsubscribeSales = onSnapshot(
          salesQuery,
          (snapshot) => {
            const sales = snapshot.docs.map((doc) => ({
              id: doc.id,
              ...doc.data(),
            }));
            renderSalesReport(sales);
          },
          (error) => {
            console.error("Error listening to sales collection:", error);
          }
        );
      }

      // Handle item form submission (Add/Update)
      itemForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("itemId").value;
        const itemData = {
          name: document.getElementById("itemName").value,
          category: document.getElementById("itemCategory").value,
          quantity: parseInt(document.getElementById("itemQuantity").value),
          price: parseFloat(document.getElementById("itemPrice").value),
        };

        try {
          if (id) {
            // Update existing item
            const itemRef = doc(db, inventoryCollection.path, id);
            await setDoc(itemRef, itemData, { merge: true });
          } else {
            // Add new item
            await addDoc(inventoryCollection, itemData);
          }
          closeModalHandler();
        } catch (error) {
          console.error("Error saving item: ", error);
        }
      });

      // Handle Sell Form Submission
      sellForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const id = document.getElementById("sellItemId").value;
        const quantityToSell = parseInt(
          document.getElementById("sellQuantity").value
        );

        const itemRef = doc(db, inventoryCollection.path, id);
        const itemSnapshot = await getDoc(itemRef);

        if (itemSnapshot.exists()) {
          const item = itemSnapshot.data();
          if (item.quantity >= quantityToSell) {
            const newQuantity = item.quantity - quantityToSell;
            await setDoc(itemRef, { quantity: newQuantity }, { merge: true });

            // Add to sales report
            await addDoc(salesCollection, {
              itemId: id,
              itemName: item.name,
              quantity: quantityToSell,
              price: item.price,
              total: item.price * quantityToSell,
              timestamp: serverTimestamp(),
            });

            closeSellModalHandler();
          } else {
            // Show warning if stock is insufficient
            alert("Not enough items in stock to sell.");
          }
        }
      });

      // Handle item deletion
      async function deleteItem(id) {
        if (window.confirm("Are you sure you want to delete this item?")) {
          try {
            await deleteDoc(doc(db, inventoryCollection.path, id));
          } catch (error) {
            console.error("Error deleting item:", error);
          }
        }
      }

      // --- Rendering Functions ---

      function renderInventory(inventory) {
        const inventoryList = document.getElementById("inventoryList");
        inventoryList.innerHTML = "";

        if (inventory.length === 0) {
          inventoryList.innerHTML = `<div class="text-center p-8 text-gray-500">No items in inventory. Click "Add New Item" to get started.</div>`;
          return;
        }

        const groupedByCategory = inventory.reduce((acc, item) => {
          const category = item.category || "Uncategorized";
          if (!acc[category]) {
            acc[category] = [];
          }
          acc[category].push(item);
          return acc;
        }, {});

        for (const category in groupedByCategory) {
          const categoryContainer = document.createElement("div");
          categoryContainer.className = "p-4 border-b";

          const categoryHeader = document.createElement("h3");
          categoryHeader.className = "text-lg font-semibold mb-2 text-gray-700";
          categoryHeader.textContent = category;
          categoryContainer.appendChild(categoryHeader);

          const tableContainer = document.createElement("div");
          tableContainer.className = "overflow-x-auto";
          const table = document.createElement("table");
          table.className = "min-w-full";
          table.innerHTML = `
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Stock</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Price</th>
                            <th class="px-4 py-2 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white">
                    </tbody>
                `;

          const tbody = table.querySelector("tbody");
          groupedByCategory[category].forEach((item) => {
            const row = document.createElement("tr");
            const stockColor =
              item.quantity === 0
                ? "text-red-500 font-bold"
                : item.quantity < 10
                ? "text-yellow-500 font-bold"
                : "";
            row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">${
                          item.name
                        }</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm ${stockColor}">${
              item.quantity
            }</td>
                        <td class="px-4 py-3 whitespace-nowrap text-sm">$${item.price.toFixed(
                          2
                        )}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button class="sell-btn bg-green-500 hover:bg-green-600 text-white font-bold py-1 px-3 rounded text-xs">Sell</button>
                            <button class="delete-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-xs ml-2">Delete</button>
                        </td>
                    `;
            row.querySelector(".sell-btn").onclick = () => openSellModal(item);
            row.querySelector(".delete-btn").onclick = () =>
              deleteItem(item.id);
            tbody.appendChild(row);
          });
          tableContainer.appendChild(table);
          categoryContainer.appendChild(tableContainer);
          inventoryList.appendChild(categoryContainer);
        }
      }

      function renderSalesReport(sales) {
        const salesReportList = document.getElementById("salesReportList");
        salesReportList.innerHTML = "";

        let totalSales = 0;
        sales.sort((a, b) => b.timestamp - a.timestamp); // Sort by most recent

        if (sales.length === 0) {
          salesReportList.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-gray-500">No sales recorded today.</td></tr>`;
        } else {
          sales.forEach((sale) => {
            const row = document.createElement("tr");
            const saleTime = sale.timestamp
              ? sale.timestamp.toDate().toLocaleTimeString()
              : "N/A";
            row.innerHTML = `
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${
                          sale.itemName
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${
                          sale.quantity
                        }</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${sale.price.toFixed(
                          2
                        )}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">$${sale.total.toFixed(
                          2
                        )}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${saleTime}</td>
                    `;
            salesReportList.appendChild(row);
            totalSales += sale.total;
          });
        }

        document.getElementById(
          "totalSalesValue"
        ).textContent = `$${totalSales.toFixed(2)}`;
        document.getElementById("totalTransactions").textContent = sales.length;
      }

      function updateSummary(inventory) {
        const totalItemsCount = inventory.reduce(
          (sum, item) => sum + item.quantity,
          0
        );
        const outOfStockCount = inventory.filter(
          (item) => item.quantity === 0
        ).length;

        document.getElementById("totalItemsCount").textContent =
          totalItemsCount;
        document.getElementById("outOfStockCount").textContent =
          outOfStockCount;
      }

      // --- Initialize app after DOM loaded ---
      window.addEventListener("DOMContentLoaded", () => {
        setupAppForUser();
      });
    </script>
  </body>
</html>
